services:
  # HAPI FHIR R4 Server - 官方 HAPI FHIR 伺服器
  hapi-fhir:
    image: hapiproject/hapi:latest
    container_name: hapi-fhir-r4
    ports:
      - "8080:8080"
    environment:
      - hapi.fhir.default_encoding=json
      - hapi.fhir.fhir_version=R4
      - hapi.fhir.allow_external_references=true
      - hapi.fhir.allow_multiple_delete=true
      - hapi.fhir.cors.allow_Credentials=true
      - hapi.fhir.cors.allowed_origin=*
    volumes:
      - hapi-data:/data/hapi
    restart: unless-stopped

  # SMART Launcher v2 - 提供 SMART on FHIR 授權代理
  smart-launcher:
    image: smartonfhir/smart-launcher-2:latest
    container_name: smart-launcher
    ports:
      - "4000:80"
    environment:
      - FHIR_SERVER_R4=http://hapi-fhir:8080/fhir
      - NODE_ENV=production
    depends_on:
      - hapi-fhir
    restart: unless-stopped

  # 核醫檢查 CDS Service (FastAPI)
  nm-cds-service:
    build:
      context: ./nm-cds-service
      dockerfile: Dockerfile
    container_name: nm-cds-service
    ports:
      - "8000:8000"
    environment:
      # 使用 SMART Launcher 的 FHIR 端點（支援 SMART on FHIR）
      # 如果直接使用 HAPI FHIR，應設定為 http://hapi-fhir:8080/fhir（但不支援 SMART on FHIR）
      - FHIR_BASE=http://smart-launcher:80/v/r4/fhir
      - CLIENT_ID=nm-cds-client
      - REDIRECT_URI=http://localhost:8000/callback
      - WEIGHT_LOOKBACK_DAYS=90
      - WEIGHT_STALE_AS_MISSING=false
      - FHIR_TIMEOUT_SEC=10
    volumes:
      - ./nm-cds-service:/app
    depends_on:
      - hapi-fhir
      - smart-launcher
    restart: unless-stopped

volumes:
  hapi-data:
    name: smarttest-hapi-data
